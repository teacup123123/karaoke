<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<style>
canvas {
    border:1px solid #d3d3d3;
    background-color: #f1f1f1;
}
</style>
</head>
<body onload="startGame()">


<!--
<button onclick="pauseAudio()" type="button">Pause Audio</button> 
-->

<script src="js/defineMyNotes.js"></script>
<script src="js/definePitchColor.js"></script>
<script>

var aud = document.createElement("AUDIO");//TODO this needs to be dynamic
aud.src = "songs/portOjisan/new.mp3";
aud.load();

detectPlayable([aud])


var gamePaused = true
var gamePausedAtMs = Date.now()
var gameStartedAtMs = Date.now()
var msPerFrame = 10
var pixPerFrame = 2//5 pixel per 10 ms means 500 pixel per second
var windowx = window.innerWidth*0.95;
var windowy = window.innerHeight*0.6;
var zeroAtPx = windowx*0.2;
var msPerPx = msPerFrame/pixPerFrame
var latestMs = (windowx-zeroAtPx)/pixPerFrame*msPerFrame
var historyMs = zeroAtPx/pixPerFrame*msPerFrame
var noteThickness = windowy/24


function changetime() {
    var para = document.getElementById("info")
	para.innerText=Date.now()
}

function playPauseAudio() { 
	if(gamePaused)
	{
		gameStartedAtMs += (Date.now()-gamePausedAtMs);
		aud.play();
		gamePaused=false;
	}
	else
	{	
		gamePaused=true	;
		aud.pause(); 
		gamePausedAtMs = Date.now();
	}
} 




var myRects = [];//all static things to be drawn is here

var blacklinerect;
function resetStaticObjects(rp=null)
{
	myRects.length=0;
	for(i =0;i<windowy/noteThickness;i++)
	{
		myRects.push(new rectangle(windowx,1,'orange',0,windowy-noteThickness*i));
	}
	blacklinerect=new rectangle(1,windowy,'black',zeroAtPx,0);
	myRects.push(blacklinerect);//this is the time = 0 bar
	pitchOffset = rp;
}

function startGame() {
    myGameArea.start();
}

var myGameArea = {
    canvas : document.createElement("canvas"),
    start : function() {
        this.canvas.width = windowx;
        this.canvas.height = windowy;
        this.context = this.canvas.getContext("2d");
        document.body.insertBefore(this.canvas, document.body.childNodes[0]);
        this.frameNo = 0;
        this.interval = setInterval(updateGameArea, msPerFrame);
    },
    stop : function() {
        clearInterval(this.interval);
    },    
    clear : function() {
        this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
    }
}

function rectangle(width, height, color, x, y,label='',isNote = false) {
    this.width = width;
    this.height = height;
    this.x = x;
    this.y = y;
	this.setx0 = function(z){this.x = z};
	this.sety0 = function(z){this.x = z};
	this.setx1 = function(z){this.width = z-this.x};
	this.sety1 = function(z){this.height = z-this.y};
	this.label = label
	
	if(Array.isArray(color))
	{
		this.colorNeutral=color[0]
		this.colorActive=color[1]
	}
	else
	{
		this.colorNeutral=color
		this.colorActive=color
	}
	this.isNote = isNote
	
	this.past = 'not yet'
	
    this.update = function() {
		if(this.isInside())
		{
			ctx = myGameArea.context;
			if(this.isNote&&this.isPlaying())
			{
				ctx.fillStyle = this.colorActive;
			}
			else
			{
				ctx.fillStyle = this.colorNeutral;
			}
			ctx.fillRect(this.x, this.y, this.width, this.height);
			ctx.fillStyle = "white";
			if(color.length>2) ctx.fillStyle = color[2];//override
			ctx.font = "20px Arial";
			ctx.fillText(this.label, this.x, this.y+noteThickness);
		}        
		if(this.past=='not yet'&&this.x<=blacklinerect.x)
		{
			this.past='passed';
			if(this.label.startsWith('轉調 to'))
			{
				fifthSignature = parseInt(note.lyric.slice(-2));
				for(i=0;i<myNotes.length;i++)
				{
					var rect_=myNotes[i].rect.col
					var color_ = pitchColor(myNotes[i].pitch)
					rect_.colorNeutral=color_[0]
					rect_.colorActive=color_[1]
				}
			}
			
		}
    }
	this.isInside = function(){//0 for no and 1 for inside
		return (this.x<=windowx)||(this.x+this.width>=0)||(this.y+this.height>=0)||(this.y<=windowy);
	}
	this.isPlaying = function()
	{
		return (this.x<=blacklinerect.x)&&(this.x+this.width>=blacklinerect.x)
	}
}

function myNote(startms, endms,pitch,lyric='', textcol='white')
{
	this.start= startms;
	this.end= endms;
	this.duration = endms-startms;
	this.pitch = pitch;
	this.lyric = lyric;
	color = pitchColor(pitch)
	color.push(textcol)
	this.rect = new rectangle(this.duration/msPerPx, noteThickness, color, windowx, windowy , lyric, true)
}

function updateGameArea() {
    myGameArea.frameNo += 1;
	if (!gamePaused)
	{
		progress = Date.now()-gameStartedAtMs;
	}
    myGameArea.clear();
	
    for (i = 0; i < myNotes.length; i += 1) {//assumes myNotes sorted by start time
		note = myNotes[i]
		if(progress + latestMs < note.start)
		{
			break;
		}
		
		if(progress - historyMs > note.end)
		{
			myNotes.splice(i,1)
			i-=1
			continue;
		}
		
		//else in the canvas
		note.rect.y = windowy-note.pitch*noteThickness;
		note.rect.x = zeroAtPx+(note.start-progress)/msPerPx;
		note.rect.update()
		
		
    }
    for (i = 0; i < myRects.length; i += 1) {
		r = myRects[i]
		r.update()
    }
}


</script>

<noscript>Sorry, your browser does not support JavaScript!</noscript>

<div style="text-align:left;width:480px;">
<p id="subtitles">Subtitles here</p>
<p id="info">Direction here</p>
<p>
	<select id="list", onchange="loadNotes()">
	</select>
	<button onclick="refreshList()" type="button">Refresh songs</button>
</p>
<button id ="playbutton" onclick="playPauseAudio()" disabled = "true" type="button">Play/Pause Karaoke</button>
<script>
function shiftBL(qtty)
{
	blacklinerect.x-=qtty;
	var dial = document.getElementById('dial')
	dial.textContent=blacklinerect.x-zeroAtPx;
}
</script>

<div class="slidecontainer">
	<input type="range" min="-500" max="500" value="0" class="slider" id="blSlider"></br>
	position of the line:<code id = 'dial'>0</code>
	<script>
		var blSlider = document.getElementById("blSlider")
		var dial = document.getElementById('dial')
		blSlider.oninput = function() {
			dial.textContent=blSlider.value;
			blacklinerect.x=zeroAtPx+parseFloat(blSlider.value);
		}
	</script>
</div>

<!--
  <button onmousedown="moveup()" onmouseup="clearmove()" ontouchstart="moveup()">UP</button><br><br>
  <button onmousedown="moveleft()" onmouseup="clearmove()" ontouchstart="moveleft()">LEFT</button>
  <button onmousedown="moveright()" onmouseup="clearmove()" ontouchstart="moveright()">RIGHT</button><br><br>
  <button onmousedown="movedown()" onmouseup="clearmove()" ontouchstart="movedown()">DOWN</button>
  -->
</div>
<script>
refreshList();
</script>
</body>
</html>
