<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<style>
canvas {
    border:1px solid #d3d3d3;
    background-color: #f1f1f1;
}
</style>
</head>
<body onload="startGame()">


<!--
<button onclick="pauseAudio()" type="button">Pause Audio</button> 
-->

<script src="js/defineMyNotes.js"></script>
<script src="js/definePitchColor.js"></script>
<script>

var aud = document.createElement("AUDIO");//TODO this needs to be dynamic
aud.src = "songs/portOjisan/new.mp3";
aud.load();
detectPlayable([aud])


var gamePaused = true
var gamePausedAtMs = Date.now()
var gameStartedAtMs = Date.now()
var msPerFrame = 10
var pixPerFrame = 2//5 pixel per 10 ms means 500 pixel per second
var windowx = window.innerWidth*0.95;
var windowy = window.innerHeight*0.6;
var zeroAtPx = windowx*0.2;
var msPerPx = msPerFrame/pixPerFrame
var latestMs = (windowx-zeroAtPx)/pixPerFrame*msPerFrame
var historyMs = zeroAtPx/pixPerFrame*msPerFrame
var noteThickness = windowy/24

function playPauseAudio() { 
	if(gamePaused)
	{
		gameStartedAtMs += (Date.now()-gamePausedAtMs);
		aud.play();
		gamePaused=false;
	}
	else
	{	
		gamePaused=true	;
		aud.pause(); 
		gamePausedAtMs = Date.now();
	}
} 


var myRects = [];//all static things to be drawn is here

var blacklinerect;
function resetStaticObjects(rp=null)
{
	myRects.length=0;
	for(i =0;i<windowy/noteThickness;i++)
	{
		myRects.push(new rectangle(windowx,1,'orange',0,windowy-noteThickness*i));
	}
	blacklinerect=new rectangle(1,windowy,'black',zeroAtPx,0);
	myRects.push(blacklinerect);//this is the time = 0 bar
	pitchOffset = rp;
}

function startGame() {
    myGameArea.start();
}

var myGameArea = {
    canvas : document.createElement("canvas"),
    start : function() {
        this.canvas.width = windowx;
        this.canvas.height = windowy;
        this.context = this.canvas.getContext("2d");
        document.body.insertBefore(this.canvas, document.body.childNodes[0]);
        this.frameNo = 0;
        this.interval = setInterval(updateGameArea, msPerFrame);
    },
    stop : function() {
        clearInterval(this.interval);
    },    
    clear : function() {
        this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
    }
}

var rescan = true;//should be unset should there be a skip
var scanStart = 0;
var scanEnd = 0;

function updateGameArea() {//assumes myNotes sorted by start time
    myGameArea.frameNo += 1;
	if (!gamePaused)
	{
		progress = Date.now()-gameStartedAtMs;
		updateFifth(prog);
	}
    myGameArea.clear();
	
	if(rescan)
	{
		//Scan global variable scanStart, breaks at first visible!
		for(i=0;i<myNotes.length;i++)
		{
			scanStart=i;
			var _ = myNotes[i];
			if(_.start<=windowx-zeroAtPx){break;}
		}
		
		
		//Scan global variable scanEnd, breaks at first invisible!
		
		for(i=scanStart;i<myNotes.length;i++)
		{
			scanEnd=i;
			var _ = myNotes[i];
			if(_.start>windowx-zeroAtPx){break;}
		}
		
		rescan = false;
	}
	else{
		for(i=scanStart;i<myNotes.length;i++)
		{
			scanStart=i;
			var _ = myNotes[i];
			if(_.start<=windowx-zeroAtPx){break;}
		}
		for(i=scanEnd;i<myNotes.length;i++)
		{
			scanEnd=i;
			var _ = myNotes[i];
			if(_.start>windowx-zeroAtPx){break;}
		}
		
	}
	
	
	//Scan between the two indexes
	for (i=scanStart; i<scanEnd; i+=1)
	{
		note = myNotes[i]
		if(progress + latestMs < note.start)
		{
			break;
		}
		
		if(progress - historyMs > note.end)
		{
			myNotes.splice(i,1)
			i-=1
			continue;
		}
		
		//else in the canvas
		note.rect.y = windowy-note.pitch*noteThickness;
		note.rect.x = zeroAtPx+(note.start-progress)/msPerPx;
		note.rect.update()
	}
	
    for (i = 0; i < myRects.length; i += 1) {
		r = myRects[i]
		r.update()
    }
}


</script>

<noscript>Sorry, your browser does not support JavaScript!</noscript>

<div style="text-align:left;width:480px;">
<p id="subtitles">Subtitles here</p>
<p id="info">Direction here</p>
<p>
	<select id="list", onchange="loadNotes()">
	</select>
	<button onclick="refreshList()" type="button">Refresh songs</button>
</p>
<button id ="playbutton" onclick="playPauseAudio()" disabled = "true" type="button">Play/Pause Karaoke</button>
<script>
function shiftBL(qtty)
{
	blacklinerect.x-=qtty;
	var dial = document.getElementById('dial')
	dial.textContent=blacklinerect.x-zeroAtPx;
}
</script>

<div class="slidecontainer">
	<input type="range" min="-500" max="500" value="0" class="slider" id="blSlider"></br>
	position of the line:<code id = 'dial'>0</code>
	<script>
		var blSlider = document.getElementById("blSlider")
		var dial = document.getElementById('dial')
		blSlider.oninput = function() {
			dial.textContent=blSlider.value;
			blacklinerect.x=zeroAtPx+parseFloat(blSlider.value);
		}
	</script>
</div>

<!--
  <button onmousedown="moveup()" onmouseup="clearmove()" ontouchstart="moveup()">UP</button><br><br>
  <button onmousedown="moveleft()" onmouseup="clearmove()" ontouchstart="moveleft()">LEFT</button>
  <button onmousedown="moveright()" onmouseup="clearmove()" ontouchstart="moveright()">RIGHT</button><br><br>
  <button onmousedown="movedown()" onmouseup="clearmove()" ontouchstart="movedown()">DOWN</button>
  -->
</div>
<script>
refreshList();
</script>
</body>
</html>
